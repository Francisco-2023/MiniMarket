{% extends 'base.html' %}
{% block title %}üõí Registrar Compras{% endblock %}

{% block content %}
<div class="container py-4">
  <h2 class="mb-4 text-primary">Registrar Compras</h2>

  <form method="POST" action="{{ url_for('compras') }}">
    <table class="table table-bordered align-middle" id="tablaCompras">
      <thead class="table-light">
        <tr>
          <th>Producto</th>
          <th>Cantidad</th>
          <th>Precio Unitario</th>
          <th>Subtotal</th>
          <th><button type="button" class="btn btn-success btn-sm" id="agregarFila">‚ûï Agregar Producto</button></th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>
            <select name="producto_id[]" class="form-select" required>
              <option value="" disabled selected>Seleccionar producto</option>
              {% for producto in productos %}
              <option value="{{ producto.id }}">{{ producto.nombre }}</option>
              {% endfor %}
            </select>
          </td>
          <td><input type="number" name="cantidad[]" class="form-control cantidad" min="1" value="1" required></td>
          <td><input type="number" name="precio_unitario[]" class="form-control precio" min="0.01" step="0.01" value="0.01" required></td>
          <td class="subtotal">$0.00</td>
          <td><button type="button" class="btn btn-danger btn-sm btn-eliminar">‚ùå</button></td>
        </tr>
      </tbody>
      <tfoot>
        <tr>
          <th colspan="3" class="text-end">Total:</th>
          <th id="totalCompra">$0.00</th>
          <th></th>
        </tr>
      </tfoot>
    </table>

    <button type="submit" class="btn btn-primary">Registrar Compra</button>
  </form>
</div>

<script>
// Funci√≥n para calcular subtotales y total
function actualizarTotales() {
  let total = 0;
  document.querySelectorAll('#tablaCompras tbody tr').forEach(row => {
    const cantidadInput = row.querySelector('.cantidad');
    const precioInput = row.querySelector('.precio');
    const subtotalCell = row.querySelector('.subtotal');

    const cantidad = parseFloat(cantidadInput.value) || 0;
    const precio = parseFloat(precioInput.value) || 0;
    const subtotal = cantidad * precio;

    subtotalCell.textContent = `$${subtotal.toFixed(2)}`;
    total += subtotal;
  });
  document.getElementById('totalCompra').textContent = `$${total.toFixed(2)}`;
}

// Evento para agregar nueva fila
document.getElementById('agregarFila').addEventListener('click', () => {
  const tablaBody = document.querySelector('#tablaCompras tbody');
  const nuevaFila = document.createElement('tr');
  nuevaFila.innerHTML = `
    <td>
      <select name="producto_id[]" class="form-select" required>
        <option value="" disabled selected>Seleccionar producto</option>
        {% for producto in productos %}
        <option value="{{ producto.id }}">{{ producto.nombre }}</option>
        {% endfor %}
      </select>
    </td>
    <td><input type="number" name="cantidad[]" class="form-control cantidad" min="1" value="1" required></td>
    <td><input type="number" name="precio_unitario[]" class="form-control precio" min="0.01" step="0.01" value="0.01" required></td>
    <td class="subtotal">$0.00</td>
    <td><button type="button" class="btn btn-danger btn-sm btn-eliminar">‚ùå</button></td>
  `;
  tablaBody.appendChild(nuevaFila);
  actualizarTotales();
});

// Delegar evento para eliminar filas
document.querySelector('#tablaCompras tbody').addEventListener('click', e => {
  if(e.target.classList.contains('btn-eliminar')){
    e.target.closest('tr').remove();
    actualizarTotales();
  }
});

// Actualizar totales al cambiar cantidad o precio
document.querySelector('#tablaCompras tbody').addEventListener('input', e => {
  if(e.target.classList.contains('cantidad') || e.target.classList.contains('precio')){
    actualizarTotales();
  }
});

// Inicializar totales al cargar p√°gina
document.addEventListener('DOMContentLoaded', actualizarTotales);
</script>
{% endblock %}
